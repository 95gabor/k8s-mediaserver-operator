name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - "**/Chart.yaml"
  workflow_dispatch:

concurrency:
  group: gh-pages-update
  cancel-in-progress: false

jobs:
  release-service-charts:
    permissions:
      contents: write # to push chart release and create a release (helm/chart-releaser-action)
      packages: write # needed for ghcr access
      id-token: write # needed for keyless signing
      pages: write # needed for GitHub Pages update

    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - uses: pre-commit/action@v3.0.1

      - name: Fetch history
        run: git fetch --prune --unshallow

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v3.5
        with:
          version: v3.12.0

      - name: Add Helm repositories for dependencies
        run: |
          helm repo add k8s-mediaserver-charts https://95gabor.github.io/k8s-mediaserver-charts || echo "Repository might not exist yet, continuing..."
          helm repo update || echo "Repository update failed, continuing..."

      - name: Temporarily exclude umbrella chart
        run: |
          mv charts/k8s-mediaserver /tmp/k8s-mediaserver || echo "Umbrella chart not found, continuing..."

      - name: Run chart-releaser for service charts
        uses: helm/chart-releaser-action@v1.5.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_GENERATE_RELEASE_NOTES: true
          CR_SKIP_EXISTING: "true"

      - name: Wait for index propagation
        run: sleep 10

  release-umbrella:
    needs: release-service-charts
    permissions:
      contents: write # to push chart release and create a release (helm/chart-releaser-action)
      packages: write # needed for ghcr access
      id-token: write # needed for keyless signing
      pages: write # needed for GitHub Pages update

    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - uses: pre-commit/action@v3.0.1

      - name: Fetch history
        run: git fetch --prune --unshallow

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v3.5
        with:
          version: v3.12.0

      - name: Add Helm repositories for dependencies
        run: |
          helm repo add k8s-mediaserver-charts https://95gabor.github.io/k8s-mediaserver-charts || echo "Repository might not exist yet, continuing..."
          helm repo update || echo "Repository update failed, continuing..."

      - name: Update umbrella chart dependencies
        continue-on-error: true
        run: |
          helm repo update k8s-mediaserver-charts || echo "Repository update failed, continuing..."
          cd charts/k8s-mediaserver
          helm dependency update || echo "Failed to update umbrella chart dependencies, skipping umbrella release..."

      # see https://github.com/helm/chart-releaser/issues/183
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run chart-releaser for umbrella chart
        continue-on-error: true
        uses: helm/chart-releaser-action@v1.5.0
        with:
          charts_dir: charts/k8s-mediaserver
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_GENERATE_RELEASE_NOTES: true
          CR_SKIP_EXISTING: "true"

      - name: Push umbrella chart to GHCR
        continue-on-error: true
        run: |
          shopt -s nullglob
          for pkg in .cr-release-packages/*; do
            if [ -f "${pkg}" ] && [[ "${pkg}" == *"k8s-mediaserver"* ]]; then
              echo "Pushing umbrella chart ${pkg} to OCI registry"
              helm push "${pkg}" "oci://ghcr.io/${GITHUB_REPOSITORY_OWNER}/charts" || echo "Failed to push ${pkg}"
            fi
          done
